document.addEventListener('DOMContentLoaded', async () => {
  // 1. 读取本地存储
  const last = localStorage.getItem('mmx:lastJob');
  if (!last) return;

  try {
    const { jobId, fp } = JSON.parse(last);

    // 2. 显示在输入框
    els.jobId.value = jobId;

    // 3. 去后端查询状态
    const res = await fetch(`${API_BASE}/api/jobs/${jobId}`);
    if (!res.ok) return;
    const data = await res.json();
    setStatus(data);

    // 4. 如果已完成 → 直接播放+挂字幕
    if (data.status === 'finished' || data.status === 'PUBLISHED') {
      const pb = data.result && data.result.playback || {};
      const finalUrl = pb.withSubUrl || pb.videoUrl || pb.originalUrl || (data.result && data.result.path);
      if (finalUrl) switchSourceKeepPosition(finalUrl);
      const subUrl = pickSubtitleUrl(data);
      if (subUrl) addVttTrackToVideo(els.player, subUrl, { lang: 'zh', label: '中文', makeDefault: true });
    } else {
      // 5. 如果还在跑 → 自动订阅 SSE
      subscribeJob(jobId);
    }
  } catch (e) {
    console.error('恢复任务失败:', e);
  }
});
